{"paragraphs":[{"text":"%spark.dep\n// Download deps\nz.load(\"org.bdgenomics.adam:adam-core-spark2_2.11:0.29.0\")\nz.addRepo(\"sonatype\").url(\"https://oss.sonatype.org/content/repositories/snapshots/\").snapshot\nz.load(\"se.uu.it:mare:0.4.0-SNAPSHOT\")","user":"anonymous","dateUpdated":"2019-12-18T15:40:25+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"res0: org.apache.zeppelin.dep.Dependency = org.apache.zeppelin.dep.Dependency@632177b\n"}]},"apps":[],"jobName":"paragraph_1576663942368_1355793991","id":"20191115-152721_1673536908","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T15:40:25+0000","dateFinished":"2019-12-18T15:40:36+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:4592"},{"text":"// Check Spark version\nsc.version","user":"anonymous","dateUpdated":"2019-12-18T15:40:26+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"res5: String = 2.3.2\n"}]},"apps":[],"jobName":"paragraph_1576663942378_1424850583","id":"20191115-152002_466578857","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T15:40:29+0000","dateFinished":"2019-12-18T15:40:44+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4593"},{"text":"// Imports\nimport org.bdgenomics.adam.io._\nimport org.apache.hadoop.io.Text\nimport se.uu.it.mare._","user":"anonymous","dateUpdated":"2019-12-18T15:40:29+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.bdgenomics.adam.io._\nimport org.apache.hadoop.io.Text\nimport se.uu.it.mare._\n"}]},"apps":[],"jobName":"paragraph_1576663942379_-701753165","id":"20191121-133156_650750325","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T15:40:36+0000","dateFinished":"2019-12-18T15:40:44+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4594"},{"text":"val nodes = 8","user":"anonymous","dateUpdated":"2019-12-18T15:40:30+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"nodes: Int = 8\n"}]},"apps":[],"jobName":"paragraph_1576663942380_-1666303101","id":"20191204-134523_1628230396","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T15:40:44+0000","dateFinished":"2019-12-18T15:40:45+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4595"},{"text":"// Read and interlace data\nval fr = sc.newAPIHadoopFile(\n    \"s3n://1000genomes/phase3/data/HG02666/sequence_read/*_1*\",\n    classOf[SingleFastqInputFormat],\n    classOf[Void],\n    classOf[Text]\n).map(_._2.toString)\nval rr = sc.newAPIHadoopFile(\n        \"s3n://1000genomes/phase3/data/HG02666/sequence_read/*_2*\",\n        classOf[SingleFastqInputFormat],\n        classOf[Void],\n        classOf[Text]\n).map(_._2.toString)\nval data = fr.zip(rr).map { \n    case(fr,rr) => fr+rr.dropRight(1) // Interlace\n}","user":"anonymous","dateUpdated":"2019-12-18T10:20:55+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"fr: org.apache.spark.rdd.RDD[String] = MapPartitionsRDD[1] at map at <console>:39\nrr: org.apache.spark.rdd.RDD[String] = MapPartitionsRDD[3] at map at <console>:38\ndata: org.apache.spark.rdd.RDD[String] = MapPartitionsRDD[5] at map at <console>:37\n"}]},"apps":[],"jobName":"paragraph_1576663942380_1952782316","id":"20191121-133240_2075256714","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T10:20:56+0000","dateFinished":"2019-12-18T10:20:59+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4596"},{"text":"// Ingest data in HDFS\ndata.repartition(nodes).saveAsTextFile(\"hdfs://spark-cluster-master-000/HG02666\")","user":"anonymous","dateUpdated":"2019-12-18T10:21:03+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576663942382_-1233125051","id":"20191122-145147_597312852","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T10:21:04+0000","dateFinished":"2019-12-18T10:25:17+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4597"},{"text":"%sh\n# Remove empty extra file\nhadoop fs -rm -r hdfs://spark-cluster-master-000/HG02666/_SUCCESS","user":"anonymous","dateUpdated":"2019-12-18T10:31:59+0000","config":{"editorSetting":{"language":"sh","editOnDblClick":false,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/sh","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"2019-12-18 10:32:05,330 INFO  [main] fs.TrashPolicyDefault (TrashPolicyDefault.java:initialize(92)) - Namenode trash configuration: Deletion interval = 0 minutes, Emptier interval = 0 minutes.\nDeleted hdfs://spark-cluster-master-000/HG02666/_SUCCESS\n"}]},"apps":[],"jobName":"paragraph_1576663942382_1791807040","id":"20191125-125048_478756895","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T10:32:00+0000","dateFinished":"2019-12-18T10:32:05+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4598"},{"text":"// Full pipeline (restart interpeter, docker containers already in nodes)\n\n// Read interleaved data\nval fastq = sc.newAPIHadoopFile(\n    \"hdfs://spark-cluster-master-000/HG02666\",\n    classOf[InterleavedFastqInputFormat],\n    classOf[Void],\n    classOf[Text]\n).map(_._2.toString)\n\n// SNP pipeline\nval res = new MaRe(fastq).map(\n    inputMountPoint = TextFile(\"/chunk.fastq\"),\n    outputMountPoint = TextFile(\"/aln.sam\"),\n    imageName = \"mcapuccini/alignment:latest\",\n    command =\n        \"\"\"\n        set -e\n        reference_genome=/ref/human_g1k_v37.fasta\n        reads=/chunk.fastq\n        bwa mem -t 8 -p $reference_genome $reads | samtools view > /aln.sam\n        \"\"\"\n).repartitionBy(\n    keyBy = (aln: String) => {\n        val chrStr = aln.split(\"\\\\s+\")(2)\n        if(chrStr.forall(Character.isDigit)) {\n            chrStr.toInt\n        } else {\n            chrStr match {\n                case \"X\" => 23\n                case \"Y\" => 24\n                case \"MT\" => 25\n                case _ => chrStr.hashCode\n            }\n        }\n    },\n    numPartitions = nodes\n).map(\n    inputMountPoint = TextFile(\"/aln.sam\"),\n    outputMountPoint = BinaryFiles(\"/results\"),\n    imageName = \"mcapuccini/alignment:latest\",\n    command =\n        \"\"\"\n        set -e\n        cat /ref/human_g1k_v37.dict /aln.sam > /aln.header.sam\n        UUID=$(cat /proc/sys/kernel/random/uuid)\n        gatk AddOrReplaceReadGroups --INPUT=/aln.header.sam \\\n            --OUTPUT=/aln.header.sorted.rg.bam \\\n            --SORT_ORDER=coordinate --RGID=HG02666-id \\\n            --RGLB=HG02666-lib \\\n            --RGPL=ILLUMINA \\\n            --RGPU=HG02666-01 \\\n            --RGSM=HG02666\n        gatk BuildBamIndex --INPUT=/aln.header.sorted.rg.bam\n        \n        reference_genome=/ref/human_g1k_v37.fasta\n        gatk HaplotypeCaller --native-pair-hmm-threads 8 -R $reference_genome -I /aln.header.sorted.rg.bam -O /results/aln.${UUID}.g.vcf\n        gzip /results/*\n        \"\"\"\n).reduce(\n    inputMountPoint = BinaryFiles(\"/in\"),\n    outputMountPoint = BinaryFiles(\"/out\"),\n    imageName = \"opengenomics/vcftools-tools:latest\",\n    command =\n        \"\"\"\n        set -e\n        UUID=$(cat /proc/sys/kernel/random/uuid)\n        vcf-concat /in/*.vcf.gz | gzip -c > /out/results.${UUID}.g.vcf.gz\n        \"\"\"\n).rdd.saveAsObjectFile(\"hdfs://spark-cluster-master-000/out\")\n// Took 4 hrs 57 min 45 sec\n// BWA 1.1 h","user":"anonymous","dateUpdated":"2019-12-18T15:39:31+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"fastq: org.apache.spark.rdd.RDD[String] = MapPartitionsRDD[1] at map at <console>:40\n"}]},"apps":[],"jobName":"paragraph_1576663942383_711286515","id":"20191122-150732_14273216","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T10:33:17+0000","dateFinished":"2019-12-18T15:31:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4599"},{"text":"// Define pipePartitions\nimport org.apache.spark.rdd.RDD\nimport scala.collection.JavaConverters.seqAsJavaListConverter\nimport scala.io.Source\nimport java.io.PrintWriter\n\ndef pipePartitions(rdd: RDD[String], command: Seq[String]) = {\n    rdd.mapPartitions { it =>\n        //Start executable\n        val pb = new ProcessBuilder(command.asJava)\n        val proc = pb.start\n    \n        // Start a thread to print the process's stderr to ours\n        new Thread(\"stderr reader\") {\n            override def run() {\n                for (line <- Source.fromInputStream(proc.getErrorStream).getLines) {\n                    System.err.println(line)\n                }\n            }\n        }.start\n    \n        // Start a thread to feed the process input \n        new Thread(\"stdin writer\") {\n            override def run() {\n                val out = new PrintWriter(proc.getOutputStream)\n                it.foreach { record =>\n                    out.print(record)\n                }\n                out.close()   \n            }\n        }.start\n        \n        //Return processed partition\n        Source.fromInputStream(proc.getInputStream).getLines()\n    }\n}","user":"anonymous","dateUpdated":"2019-12-18T15:40:33+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.apache.spark.rdd.RDD\nimport scala.collection.JavaConverters.seqAsJavaListConverter\nimport scala.io.Source\nimport java.io.PrintWriter\npipePartitions: (rdd: org.apache.spark.rdd.RDD[String], command: Seq[String])org.apache.spark.rdd.RDD[String]\n"}]},"apps":[],"jobName":"paragraph_1576663942383_1856258613","id":"20191205-114334_1532054385","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T15:40:44+0000","dateFinished":"2019-12-18T15:40:46+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4600"},{"text":"// Bwa with RDD pipe (restart interpeter, docker containers already in nodes)\n\n// Read interleaved data\nval fastq = sc.newAPIHadoopFile(\n    \"hdfs://spark-cluster-master-000/HG02666\",\n    classOf[InterleavedFastqInputFormat],\n    classOf[Void],\n    classOf[Text]\n).map(_._2.toString)\n\n// Bwa\nval sam = pipePartitions(\n    fastq,\n    Seq(\"docker\", \"run\", \"-i\", \"mcapuccini/alignment:latest\", \"sh\", \"-c\", \n        \"bwa mem -t 8 -p /ref/human_g1k_v37.fasta - | samtools view\"\n    )\n)\n\n// Partition by\nval partSam = sam.keyBy { aln =>\n    val chrStr = aln.split(\"\\\\s+\")(2)\n    if(chrStr.forall(Character.isDigit)) {\n        chrStr.toInt\n    } else {\n        chrStr match {\n            case \"X\" => 23\n            case \"Y\" => 24\n            case \"MT\" => 25\n            case _ => chrStr.hashCode\n        }\n    }\n}.partitionBy(new org.apache.spark.HashPartitioner(nodes)).map(_._2)\n\n// Save\npartSam.saveAsTextFile(\"hdfs://spark-cluster-master-000/out_pipe\")\n// Took 51 min 21 sec","user":"anonymous","dateUpdated":"2019-12-19T08:59:47+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"fastq: org.apache.spark.rdd.RDD[String] = MapPartitionsRDD[1] at map at <console>:44\nsam: org.apache.spark.rdd.RDD[String] = MapPartitionsRDD[2] at mapPartitions at <console>:36\npartSam: org.apache.spark.rdd.RDD[String] = MapPartitionsRDD[5] at map at <console>:58\n"}]},"apps":[],"jobName":"paragraph_1576663942384_384430052","id":"20191204-160505_1543275415","dateCreated":"2019-12-18T10:12:22+0000","dateStarted":"2019-12-18T15:40:45+0000","dateFinished":"2019-12-18T16:32:06+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4601"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1576683637283_-187985109","id":"20191218-154037_1585969400","dateCreated":"2019-12-18T15:40:37+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:4602"}],"name":"snp_8_nodes","id":"2EWCYNSVH","noteParams":{},"noteForms":{},"angularObjects":{"sh:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}